---
title: "Title of Your Report"
author: "Xu Xinyi" # Add names here 
date: "2020/10/31"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
library(tidyverse)
library(lme4)

# Loading in the cleaned survey Data
survey_data <- read_csv("survey_data.csv")

# Through observation we found that some hispan types does not exist in 
# his_age_sex.csv thus we mutate the missing hispan types to other hispan
head(survey_data)

survey_data[survey_data=="Colombian"]<-"Other Hispanic"
survey_data[survey_data=="Ecuadorian"]<-"Other Hispanic"
survey_data[survey_data=="Guatemalan"]<-"Other Hispanic"
survey_data[survey_data=="Nicaraguan"]<-"Other Hispanic"
survey_data[survey_data=="Panamanian"]<-"Other Hispanic"
survey_data[survey_data=="Peruvian"]<-"Other Hispanic"
survey_data[survey_data=="Salvadorean"]<-"Other Hispanic"
survey_data[survey_data=="Spanish"]<-"Other Hispanic"
survey_data[survey_data=="Venezuelan"]<-"Other Hispanic"

# futher_survey_cleaning <- 
#   survey_data %>% 
#   select(vote_2020,
#          gender,
#          hispanic,
#          race_ethnicity,
#          household_income,
#          education,
#          state,
#          age,
#          vote_trump,
#          vote_biden)
#   
# write_csv(futher_survey_cleaning, "futher_survey_cleaning.csv")

# Loading in the cleaned census Data
# census_data <- read_csv("census_data.csv")

# Loading in the futher_survey_cleaning Data
futher_survey_cleaning <- read_csv("futher_survey_cleaning.csv")

# Loading in the cleaned his_age_sex Data
his_age_sex <- read_csv("his_age_sex.csv")

his_age_sex<-his_age_sex %>% 
  mutate(state = case_when(stateicp=="alabama"~"AL",
                           stateicp=="alaska"~"AK",
                           stateicp=="arizona"~"AZ",
                           stateicp=="arkansas"~"AR",
                           stateicp=="california"~"CA",
                           stateicp=="colorado"~"CO",
                           stateicp=="connecticut"~"CT",
                           stateicp=="delaware"~"DE",
                           stateicp=="florida"~"FL",
                           stateicp=="georgia"~"GA",
                           stateicp=="hawaii"~"HI",
                           stateicp=="idaho"~"ID",
                           stateicp=="illinois"~"IL",
                           stateicp=="indiana"~"IN",
                           stateicp=="iowa"~"IA",
                           stateicp=="kansas"~"KS",
                           stateicp=="kentucky"~"KY",
                           stateicp=="louisiana"~"LA",
                           stateicp=="maine"~"ME",
                           stateicp=="maryland"~"MD",
                           stateicp=="massachusetts"~"MA",
                           stateicp=="michigan"~"MI",
                           stateicp=="minnesota"~"MN",
                           stateicp=="mississippi"~"MS",
                           stateicp=="missouri"~"MO",
                           stateicp=="montana"~"MT",
                           stateicp=="nebraska"~"NE",
                           stateicp=="nevada"~"NV",
                           stateicp=="new hampshire"~"NH",
                           stateicp=="new jersey"~"NJ",
                           stateicp=="new mexico"~"NM",
                           stateicp=="new york"~"NY",
                           stateicp=="north carolina"~"NC",
                           stateicp=="north dakota"~"ND",
                           stateicp=="ohio"~"OH",
                           stateicp=="oklahoma"~"OK",
                           stateicp=="oregon"~"OR",
                           stateicp=="pennsylvania"~"PA",
                           stateicp=="rhode island"~"RI",
                           stateicp=="south carolina"~"SC",
                           stateicp=="south dakota"~"SD",
                           stateicp=="tennessee"~"TN",
                           stateicp=="texas"~"TX",
                           stateicp=="utah"~"UT",
                           stateicp=="vermont"~"VT",
                           stateicp=="virginia"~"VA",
                           stateicp=="washington"~"WA",
                           stateicp=="west virginia"~"WV",
                           stateicp=="wisconsin"~"WI",
                           stateicp=="wyoming"~"WY",
                           stateicp=="district of columbia"~"DC")) 
his_age_sex$stateicp<-NULL


# Loading in the new cleaned his_age_sex Data
n_his <- read_csv("n_his.csv")

n_his<-n_his %>% 
  mutate(state = case_when(stateicp=="alabama"~"AL",
                           stateicp=="alaska"~"AK",
                           stateicp=="arizona"~"AZ",
                           stateicp=="arkansas"~"AR",
                           stateicp=="california"~"CA",
                           stateicp=="colorado"~"CO",
                           stateicp=="connecticut"~"CT",
                           stateicp=="delaware"~"DE",
                           stateicp=="florida"~"FL",
                           stateicp=="georgia"~"GA",
                           stateicp=="hawaii"~"HI",
                           stateicp=="idaho"~"ID",
                           stateicp=="illinois"~"IL",
                           stateicp=="indiana"~"IN",
                           stateicp=="iowa"~"IA",
                           stateicp=="kansas"~"KS",
                           stateicp=="kentucky"~"KY",
                           stateicp=="louisiana"~"LA",
                           stateicp=="maine"~"ME",
                           stateicp=="maryland"~"MD",
                           stateicp=="massachusetts"~"MA",
                           stateicp=="michigan"~"MI",
                           stateicp=="minnesota"~"MN",
                           stateicp=="mississippi"~"MS",
                           stateicp=="missouri"~"MO",
                           stateicp=="montana"~"MT",
                           stateicp=="nebraska"~"NE",
                           stateicp=="nevada"~"NV",
                           stateicp=="new hampshire"~"NH",
                           stateicp=="new jersey"~"NJ",
                           stateicp=="new mexico"~"NM",
                           stateicp=="new york"~"NY",
                           stateicp=="north carolina"~"NC",
                           stateicp=="north dakota"~"ND",
                           stateicp=="ohio"~"OH",
                           stateicp=="oklahoma"~"OK",
                           stateicp=="oregon"~"OR",
                           stateicp=="pennsylvania"~"PA",
                           stateicp=="rhode island"~"RI",
                           stateicp=="south carolina"~"SC",
                           stateicp=="south dakota"~"SD",
                           stateicp=="tennessee"~"TN",
                           stateicp=="texas"~"TX",
                           stateicp=="utah"~"UT",
                           stateicp=="vermont"~"VT",
                           stateicp=="virginia"~"VA",
                           stateicp=="washington"~"WA",
                           stateicp=="west virginia"~"WV",
                           stateicp=="wisconsin"~"WI",
                           stateicp=="wyoming"~"WY",
                           stateicp=="district of columbia"~"DC")) 
n_his$stateicp<-NULL

unique(n_his$state)
unique(futher_survey_cleaning$state)
unique(his_age_sex$state)
```

# Title of your Report

## Xu Xinyi  
## 2020/10/31


# Model

Here we are interested in predicting the popular vote outcome of the 2020 American federal election (include citation). To do this we are employing a post-stratification technique. In the following sub-sections I will describe the model specifics and the post-stratification calculation.


## Model Specifics
I will (incorrectly) be using a linear regression model to model the proportion of voters who will vote for Donald Trump. This is a naive model. I will only be using age, which is recorded as a numeric variable, to model the probability of voting for Donald Trump. The simple linear regression model I am using is:

#TODO change the following model interpretation
$$ p(Yi = Donald \ Trump | state_j) = logit^{-1}(\beta_{j0} + \beta_{ji}^{age} + b_{[i]}^{gender} + b_{[i]}^{hispanic}) $$

Where $y$ represents the proportion of voters who will vote for Donald Trump. Similarly, $\beta_0$ represents the intercept of the model, and is the probability of voting for Donald Trump at age 0. Additionally, $\beta_1$ represents the slope of the model. So, for everyone one unit increase in age, we expect a $\beta_1$ increase in the probability of voting for Donald Trump.

```{r Model creation, warning=FALSE, echo=FALSE}
# Creating the Model
modelt <- glmer(vote_trump ~ (1 + age|state) + gender + hispanic,
                data=futher_survey_cleaning, family="binomial")

modelb <- glmer(vote_biden ~ (1 + age|state) + gender + hispanic, 
                data=futher_survey_cleaning, family="binomial")
# Model Results (to Report in Results section)
# summary(modelh)
# OR
# broom::tidy(model)
summary(modelt)
summary(modelb)
```

## Post-Stratification 

In order to estimate the proportion of voters who will vote for Donald Trump I need to perform a post-stratification analysis. Here I create cells based off different ages. Using the model described in the previous sub-section I will estimate the proportion of voters in each age bin. I will then weight each proportion estimate (within each bin) by the respective population size of that bin and sum those values and divide that by the entire population size. 

```{r Data editing, include=FALSE}
# Data editing
glimpse(his_age_sex)
glimpse(survey_data)
# Data with NA in citizen category.
his_age_sex<- his_age_sex %>% 
  rename(gender = sex) %>% mutate(gender = ifelse(gender == "male","Male","Female"))
his_age_sex <- his_age_sex  %>% mutate(age = age + 2)
his_age_sex<- his_age_sex %>% rename(hispanic = hispan)
his_age_sex[his_age_sex=="not hispanic"]<-"Not Hispanic"
his_age_sex[his_age_sex=="other"]<-"Other Hispanic"
his_age_sex[his_age_sex=="mexican"]<-"Mexican"
his_age_sex[his_age_sex=="puerto rican"]<-"Puerto Rican"
his_age_sex[his_age_sex=="cuban"]<-"Cuban"

# Data without NA in citizen category. 
n_his<- n_his %>% 
  rename(gender = sex) %>% mutate(gender = ifelse(gender == "male","Male","Female"))
n_his <- n_his  %>% mutate(age = age + 2)
n_his<- n_his %>% rename(hispanic = hispan)
n_his[n_his=="not hispanic"]<-"Not Hispanic"
n_his[n_his=="other"]<-"Other Hispanic"
n_his[n_his=="mexican"]<-"Mexican"
n_his[n_his=="puerto rican"]<-"Puerto Rican"
n_his[n_his=="cuban"]<-"Cuban"

```

```{r Process estimation, echo=FALSE}
# TODO: The below was edited. See if any changes was needed. Maybe a calculation of p-value or something.
# Here I will perform the post-stratification calculation
# Data with NA in citizen category.
his_age_sex$estimate_trump <-
  modelt %>%
  predict(newdata = his_age_sex, type = "response")

his_age_sex$estimate_biden <-
  modelb %>%
  predict(newdata = his_age_sex, type = "response")

his_age_sex %>%
  mutate(alp_predict_prop = estimate_trump*n) %>%
  summarise(alp_predict = sum(alp_predict_prop)/sum(n))

his_age_sex %>%
  mutate(alp_predict_prop = estimate_biden*n) %>%
  summarise(alp_predict = sum(alp_predict_prop)/sum(n))

# Data without NA in citizen category. 
n_his$estimate_trump <-
  modelt %>%
  predict(newdata = n_his, type = "response")

n_his$estimate_biden <-
  modelb %>%
  predict(newdata = n_his, type = "response")

n_his %>%
  mutate(alp_predict_prop = estimate_trump*n) %>%
  summarise(alp_predict = sum(alp_predict_prop)/sum(n))

n_his %>%
  mutate(alp_predict_prop = estimate_biden*n) %>%
  summarise(alp_predict = sum(alp_predict_prop)/sum(n))
```

```{r prediction by state with NA citizen, warning=FALSE, echo=FALSE}
vote_2020_prob<-predict(modelt,his_age_sex[,c("age","gender","hispanic","state")],type="response")
# vote_2020_pred<-ifelse(vote_2020_prob>0.5,"Joe Biden","Donald Trump")
vote_2020_pred<-ifelse(vote_2020_prob>0.5,"Donald Trump","Joe Biden")
his_age_sex.result<-cbind(his_age_sex,vote_2020_pred)

his_age_sex.result$trump_votes<-ifelse(his_age_sex.result$vote_2020_pred=="Donald Trump",his_age_sex.result$perwt,0)
his_age_sex.result$biden_votes<-ifelse(his_age_sex.result$vote_2020_pred=="Joe Biden",his_age_sex.result$perwt,0)

his_age_sex.result %>% group_by(state) %>% summarise(Trump=sum(trump_votes),Biden=sum(biden_votes))->predicted_states_na
predicted_states_na$winner<-ifelse(predicted_states_na$Trump>predicted_states_na$Biden,
                                "Donald Trump","Joe Biden")

predicted_states_na<-predicted_states_na %>% 
  mutate(electoral_votes = case_when(state=="CA"~55,state=="TX"~38,state=="FL"~29,state=="NY"~29,state=="IL"~20,state=="PA"~20,state=="OH"~18,
                                     state=="GA"~16,state=="MI"~16,state=="NC"~15,state=="NJ"~14,state=="VA"~13,state=="WA"~12,state=="AZ"~11,
                                     state=="IN"~11,state=="MA"~11,state=="TN"~11,state=="MD"~10,state=="MN"~10,state=="MO"~10,state=="WI"~10,
                                     state=="AL"~9,state=="CO"~9,state=="SC"~9,state=="KY"~8,state=="LA"~8,state=="CT"~7,state=="OK"~7,
                                     state=="OR"~7,state=="AR"~6,state=="IA"~6,state=="KS"~6,state=="MS"~6,state=="NV"~6,state=="UT"~6,
                                     state=="NE"~5,state=="NM"~5,state=="WV"~5,state=="HI"~4,state=="ID"~4,state=="ME"~4,state=="NH"~4,
                                     state=="RI"~4,state=="AK"~3,state=="DE"~3,state=="MT"~3,state=="ND"~3,state=="SD"~3,state=="VT"~3,
                                     state=="WY"~3,state=="DC"~3
  )) 


predicted_states_na %>% group_by(winner) %>% summarise(total_votes=sum(electoral_votes))->election_result
election_result

```

```{r prediction by state without NA citizen, warning=FALSE}
vote_2020_prob_n<-predict(modelt,n_his[,c("age","gender","hispanic","state")],type="response")
# vote_2020_pred_n<-ifelse(vote_2020_prob_n>0.5,"Joe Biden","Donald Trump")
vote_2020_pred_n<-ifelse(vote_2020_prob_n>0.5,"Donald Trump","Joe Biden")
n_his.result<-cbind(n_his,vote_2020_pred_n)

n_his.result$trump_votes<-ifelse(n_his.result$vote_2020_pred=="Donald Trump",n_his.result$perwt,0)
n_his.result$biden_votes<-ifelse(n_his.result$vote_2020_pred=="Joe Biden",n_his.result$perwt,0)

n_his.result %>% group_by(state) %>% summarise(Trump=sum(trump_votes),Biden=sum(biden_votes))->predicted_states
predicted_states$winner<-ifelse(predicted_states$Trump>predicted_states$Biden,
                                "Donald Trump","Joe Biden")

predicted_states<-predicted_states %>% 
  mutate(electoral_votes = case_when(state=="CA"~55,state=="TX"~38,state=="FL"~29,state=="NY"~29,state=="IL"~20,state=="PA"~20,state=="OH"~18,
                                     state=="GA"~16,state=="MI"~16,state=="NC"~15,state=="NJ"~14,state=="VA"~13,state=="WA"~12,state=="AZ"~11,
                                     state=="IN"~11,state=="MA"~11,state=="TN"~11,state=="MD"~10,state=="MN"~10,state=="MO"~10,state=="WI"~10,
                                     state=="AL"~9,state=="CO"~9,state=="SC"~9,state=="KY"~8,state=="LA"~8,state=="CT"~7,state=="OK"~7,
                                     state=="OR"~7,state=="AR"~6,state=="IA"~6,state=="KS"~6,state=="MS"~6,state=="NV"~6,state=="UT"~6,
                                     state=="NE"~5,state=="NM"~5,state=="WV"~5,state=="HI"~4,state=="ID"~4,state=="ME"~4,state=="NH"~4,
                                     state=="RI"~4,state=="AK"~3,state=="DE"~3,state=="MT"~3,state=="ND"~3,state=="SD"~3,state=="VT"~3,
                                     state=="WY"~3,state=="DC"~3
  )) 


predicted_states %>% group_by(winner) %>% summarise(total_votes=sum(electoral_votes))->election_result
election_result

```

```{r Support rate}
support_rate_trump <- 115/538
support_rate_trump

support_rate_biden <- 423/538
support_rate_biden
```

```{r tester, warning=FALSE, echo=FALSE}
library(tableHTML)
n_his.result %>% group_by(hispanic) %>% summarise(Trump=sum(trump_votes),Biden=sum(biden_votes))->predicted_hispanic
predicted_hispanic$winner<-ifelse(predicted_hispanic$Trump>predicted_hispanic$Biden,
                                "Donald Trump","Joe Biden")
# glimpse(predicted_hispanic)
tableHTML(predicted_hispanic)
```

```{r plot, warning=FALSE, echo=FALSE}
n_his.result %>%
  ggplot(aes(y = estimate_trump, x = forcats::fct_inorder(state), 
             color = "Support rate estimate")) + geom_point() +
  ylab("Proportion Support Trump") + xlab("State") + 
  geom_point(data = n_his.result %>%
               group_by(state, estimate_trump) %>% summarise(n = n()) %>% 
               group_by(state) %>%
               mutate(prop = n/sum(n))) + coord_flip()

predicted_states %>%
  filter(winner!="Joe Biden") %>%
  ggplot(aes(y = electoral_votes, x = forcats::fct_inorder(state), 
             color = "Election estimate")) + geom_point() +
  ylab("State Support Trump") + xlab("Amount of the credit") + coord_flip()

predicted_states %>%
  filter(winner!="Donald Trump") %>%
  ggplot(aes(y = electoral_votes, x = forcats::fct_inorder(state), 
             color = "Election estimate")) + geom_point() +
  ylab("State Support Biden") + xlab("Amount of the credit") + coord_flip()
```
# Results

Here you will include all results. This includes descriptive statistics, graphs, figures, tables, and model results. Please ensure that everything is well formatted and in a report style. You must also provide an explanation of the results in this section. 

Please ensure that everything is well labelled. So if you have multiple histograms and plots, calling them Figure 1, 2, 3, etc. and referencing them as Figure 1, Figure 2, etc. in your report will be expected. The reader should not get lost in a sea of information. Make sure to have the results be clean, well formatted and digestible.

# Discussion

Here you will summarize the previous sections and discuss conclusions drawn from the results. Make sure to elaborate and connect your analysis to the goal of the study.

## Weaknesses

Here we discuss weaknesses of the study, data, analysis, etc. You can also discuss areas for improvement.

## Next Steps

Here you discuss subsequent work to be done after this report. This can include next steps in terms of statistical analysis (perhaps there is a more efficient algorithm available, or perhaps there is a caveat in the data that would allow for some new technique). Future steps should also be specified in terms of the study setting (eg. including a follow-up survey on something, or a subsequent study that would complement the conclusions of your report).


# References



